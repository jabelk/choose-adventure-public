# Implementation Plan: Refresh Templates Button

**Branch**: `034-refresh-templates` | **Date**: 2026-02-07 | **Spec**: [spec.md](spec.md)
**Input**: Feature specification from `/specs/034-refresh-templates/spec.md`

## Summary

Add a shuffle button to the home page template section that lets users get a new random selection of story templates without reloading the page. Expand the template pool to at least 12 per tier so shuffling reveals genuinely new options. All templates render server-side as hidden cards; JavaScript shows/hides subsets of 6 at a time.

## Technical Context

**Language/Version**: Python 3.11 + JavaScript (vanilla, no framework)
**Primary Dependencies**: FastAPI, Jinja2, Pydantic
**Storage**: N/A (templates are hardcoded in `app/tiers.py`)
**Testing**: pytest with FastAPI TestClient
**Target Platform**: Web (Docker on Linux NUC, dev on macOS)
**Project Type**: Web application (server-rendered with JS enhancement)
**Performance Goals**: Shuffle completes in <100ms (client-side only, no network)
**Constraints**: No additional dependencies, no API endpoints needed
**Scale/Scope**: ~12-20 templates per tier, 2 tiers

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Notes |
|-----------|--------|-------|
| I. Content Isolation | PASS | Templates are per-tier in `TierConfig.templates`. Shuffle operates within a single tier's pool only. No cross-tier exposure. |
| II. Local-First | PASS | Shuffle is entirely client-side JavaScript. No external API calls needed. |
| III. Iterative Simplicity | PASS | Minimal change: add templates to existing list, render all as hidden, add a small JS function. No new abstractions. |
| IV. Archival by Design | N/A | Templates are not persistent data; they're starter prompts. |
| V. Fun Over Perfection | PASS | Small, fun feature with minimal code. No over-engineering. |

## Project Structure

### Documentation (this feature)

```text
specs/034-refresh-templates/
├── plan.md              # This file
├── research.md          # Phase 0 output
├── spec.md              # Feature specification
├── checklists/
│   └── requirements.md  # Spec quality checklist
└── tasks.md             # Phase 2 output (generated by /speckit.tasks)
```

### Source Code (files modified)

```text
app/
└── tiers.py                   # Add new templates to kids and NSFW pools

templates/
└── home.html                  # Render all templates as hidden, show 6, add shuffle button

static/
├── css/
│   └── style.css              # Shuffle button styling
└── js/
    └── template-shuffle.js    # Shuffle logic (show/hide cards, randomize)

tests/
└── test_template_shuffle.py   # Verify shuffle button present, template count, both tiers
```

**Structure Decision**: Follows existing project structure. New JS file `template-shuffle.js` to keep shuffle logic separate from the existing `app.js`. Templates stay in `tiers.py` as hardcoded `StoryTemplate` objects — no new data model needed.

## Key Implementation Details

### Template Rendering Strategy

1. **Server side (Jinja2)**: Render ALL templates as `.template-card` divs inside the `.template-grid`. Each card gets a `data-template-index` attribute. All cards start hidden via CSS class `.template-hidden`.

2. **Client side (JS)**: On page load, `initTemplateShuffle()` picks 6 random indices and removes `.template-hidden` from those cards. The shuffle button re-randomizes which 6 are visible.

3. **Fallback**: If JS is disabled, all templates are visible (CSS `.template-hidden` is applied by JS, not by default). This gracefully degrades.

### Shuffle Algorithm

- Fisher-Yates shuffle on array of indices [0..N-1]
- Take first 6 from shuffled array
- Hide all cards, then show the selected 6
- Ensure no duplicate of previous selection when pool > 12 (exclude previously shown set, then fill)

### New Kids Templates (6 additions to reach 12)

- Baking Adventure (cookie decorating)
- Dinosaur Park (friendly dinos)
- Rainbow Bridge (magical bridge to cloud kingdom)
- Pirate Penguins (penguin crew treasure hunt)
- Magic Garden (growing giant flowers)
- Robot Best Friend (building a robot companion)

### New NSFW Templates (2 additions to reach 12)

- Wine Bar Encounter (upscale wine bar, slow-burn seduction)
- Beach House Weekend (weekend getaway, building tension)
