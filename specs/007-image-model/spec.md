# Feature Specification: Image Model Selection

**Feature Branch**: `007-image-model`
**Created**: 2026-02-07
**Status**: Draft
**Input**: User description: "Image Model Selection - Allow users to choose which AI generates story images. Currently only OpenAI gpt-image-1 is used. Add support for Gemini image generation as an alternative. Show an image model selector on the start form alongside the existing text model selector. The image model selection should be stored with the story. Each tier can have different default image models. Reuse the same registry pattern from 006-multi-model but for image providers. Start with OpenAI (gpt-image-1) and Gemini (imagen) as the two options. The image model selector should only appear if multiple image models are available (i.e., multiple API keys configured)."

## User Scenarios & Testing *(mandatory)*

### User Story 1 - Choose an Image Model (Priority: P1)

As a user starting a new story, I want to select which AI generates the story illustrations so I can compare art styles between different image providers.

**Why this priority**: This is the core feature. Without this, the user has no way to choose an image model — everything else depends on this selection working.

**Independent Test**: Start a story with the default image model, verify images generate. Start another story selecting the alternate image model, verify images generate with a visibly different style. Both stories show the correct image model name.

**Acceptance Scenarios**:

1. **Given** the start form with both OpenAI and Gemini API keys configured, **When** the user views the form, **Then** an image model selector appears with both options as radio cards
2. **Given** the start form with only one image provider's API key configured, **When** the user views the form, **Then** no image model selector appears (the sole provider is used automatically)
3. **Given** the user selects "Gemini" as the image model, **When** they start the story, **Then** all scene illustrations are generated by Gemini
4. **Given** a story is in progress, **When** the user makes choices and new scenes generate, **Then** all subsequent images use the same image model selected at story start

---

### User Story 2 - Tier Default Image Models (Priority: P2)

As a tier administrator, I want each tier to have a configurable default image model so that the kids tier can default to the image provider that best suits children's illustrations.

**Why this priority**: Builds on US1 to provide a better default experience per audience. Secondary because a global default is adequate for MVP.

**Independent Test**: Visit the kids tier — verify the configured default image model is pre-selected. Visit the adult tier — verify its configured default is pre-selected. If the default model's API key is removed, verify fallback to the remaining available provider.

**Acceptance Scenarios**:

1. **Given** the kids tier is configured with a specific default image model, **When** the user opens the start form, **Then** that model is pre-selected
2. **Given** the tier's default image model is unavailable (no API key), **When** the user opens the start form, **Then** the first available image model is pre-selected instead

---

### User Story 3 - Image Model Attribution (Priority: P2)

As a user browsing the gallery or reading a saved story, I want to see which image model was used so I can compare the visual quality of different AI image generators.

**Why this priority**: Enhances the gallery experience but is not essential for core image generation functionality.

**Independent Test**: Complete a story using Gemini images. View the gallery — verify "Gemini" appears on the story card. Open the story in the reader — verify the image model name is visible.

**Acceptance Scenarios**:

1. **Given** a completed story that used Gemini for images, **When** the user views it in the gallery, **Then** the image model name "Gemini" is displayed on the story card
2. **Given** a completed story in the reader, **When** the user views any scene, **Then** the image model name is visible in the scene or story header
3. **Given** a pre-existing story saved before this feature, **When** it is displayed in the gallery or reader, **Then** it shows "DALL-E" as the image model (backward compatible default)

---

### Edge Cases

- What happens when the only configured image API key is removed between story start and scene generation? The system should show an error for that scene's image but not crash the story.
- What happens when a saved story references an image model that no longer exists in the registry? It should display the stored model name as-is.
- What happens when a user retries/regenerates an image? The retry should use the same image model that was selected for the story.
- What happens when no image model API keys are configured? Images should fail gracefully with the existing fallback behavior — story text still works.

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: System MUST support at least two image generation providers: OpenAI (DALL-E) and Google Gemini (Imagen)
- **FR-002**: System MUST display an image model selector on the story start form when more than one image provider is available
- **FR-003**: System MUST NOT display the image model selector when only one (or zero) image providers are available
- **FR-004**: Users MUST be able to select an image model via radio card UI, consistent with the existing text model and story length selectors
- **FR-005**: System MUST store the selected image model with the story so all scenes in a story use the same image provider
- **FR-006**: System MUST use the selected image model for all image generation within a story, including retries and regenerations
- **FR-007**: Each tier MUST have a configurable default image model that is pre-selected on the start form
- **FR-008**: System MUST fall back to the first available image provider if the tier's default is unavailable
- **FR-009**: System MUST display the image model name alongside the text model name in the gallery and reader views
- **FR-010**: Pre-existing stories without an image model field MUST default to "dalle" (backward compatibility)
- **FR-011**: The image model registry MUST follow the same pattern as the existing text model registry (provider key, display name, API key check)

### Key Entities

- **ImageProvider**: An image generation service configuration — has a unique key (e.g., "dalle", "gemini"), a display name (e.g., "DALL-E", "Gemini"), and an associated API key requirement
- **Story.image_model**: The selected image provider key, stored on the story and persisted through session saves and gallery archives

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: Users can select an image model on the start form and all scene images in that story are generated by the selected provider
- **SC-002**: Image model selector only appears when 2+ image providers are available; invisible with only 1 provider
- **SC-003**: Gallery and reader views display the image model name for completed stories
- **SC-004**: Pre-existing stories display without errors, defaulting to the original image provider name

## Assumptions

- The Gemini API supports image generation via the same API key used for text generation (GEMINI_API_KEY)
- OpenAI continues to use the existing OPENAI_API_KEY for image generation (no separate key needed)
- Image generation latency may differ between providers; no specific performance requirements beyond existing behavior
- The image model selection is per-story (not per-scene) — the same provider generates all images in a story
- The kids tier and adult tier may have different default image models but all image providers are available in all tiers
