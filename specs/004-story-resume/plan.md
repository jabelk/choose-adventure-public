# Implementation Plan: Story Resume

**Branch**: `004-story-resume` | **Date**: 2026-02-07 | **Spec**: [spec.md](spec.md)
**Input**: Feature specification from `/specs/004-story-resume/spec.md`

## Summary

Persist in-progress story sessions to disk so users can resume after closing their browser or server restarts. The tier home page shows a resume banner when a save exists, with "Continue" and "Start Fresh" options. Completed or abandoned stories clean up their save files. One save per tier, stored as JSON in `data/progress/`.

## Technical Context

**Language/Version**: Python 3 (matches existing project)
**Primary Dependencies**: FastAPI, Pydantic, Jinja2 (all existing — no new dependencies)
**Storage**: JSON files in `data/progress/{tier_name}.json`
**Testing**: Manual (per Principle V)
**Target Platform**: Local LAN server (Intel NUC)
**Project Type**: Single web application
**Performance Goals**: N/A — personal single-user app
**Constraints**: Must work offline for reading/browsing (Principle II)
**Scale/Scope**: 2 tiers, 1 save file per tier max

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Notes |
|-----------|--------|-------|
| I. Content Isolation | PASS | Each tier gets its own independent progress file (`kids.json`, `nsfw.json`). No cross-tier access. |
| II. Local-First | PASS | Progress files stored locally. No cloud dependency. Resume works offline. |
| III. Iterative Simplicity | PASS | Reuses existing StorySession model and GalleryService. No new abstractions or dependencies. |
| IV. Archival by Design | PASS | Progress saved as human-readable JSON. Full session state preserved including branching tree. |
| V. Fun Over Perfection | PASS | Simple file-based approach. No database, no complex sync logic. 3 new methods on existing service. |

**Post-design re-check**: All gates still pass. The design adds 3 methods to GalleryService, 2 new routes, modifies 4 existing routes, and updates 1 template. No new files except the progress directory.

## Project Structure

### Documentation (this feature)

```text
specs/004-story-resume/
├── plan.md              # This file
├── research.md          # 8 design decisions
├── data-model.md        # InProgressSave entity and state transitions
├── quickstart.md        # Manual testing guide
├── contracts/
│   └── routes.md        # 2 new routes, 4 modified routes
└── tasks.md             # To be generated by /speckit.tasks
```

### Source Code (repository root)

```text
app/
├── main.py              # Add data/progress/ directory creation
├── routes.py            # Add resume/abandon routes, wire auto-save to existing routes
├── session.py           # No changes needed
├── models.py            # No changes needed (StorySession already serializable)
├── services/
│   ├── gallery.py       # Add save_progress(), load_progress(), delete_progress()
│   ├── story.py         # No changes
│   └── image.py         # No changes
└── tiers.py             # No changes

templates/
├── home.html            # Add resume banner (conditional)
└── (others unchanged)

static/
└── css/style.css        # Add resume banner styles

data/
├── stories/             # Existing gallery data
└── progress/            # NEW: in-progress saves (kids.json, nsfw.json)
```

**Structure Decision**: Extends existing single-project layout. No new service files — progress persistence methods added to GalleryService. One new data directory (`data/progress/`).

## Complexity Tracking

No constitution violations. No complexity justifications needed.
